From 2b852c78f74b17c49e3688bb1c57676148229af2 Mon Sep 17 00:00:00 2001
From: yatinkarel <ykarel@redhat.com>
Date: Fri, 11 Dec 2020 21:40:43 +0530
Subject: [PATCH] Move pci class invocation to before nova::compute

[1] handled it for nova::pci, issue with nova::compute::pci appeared
post [2], this patch is moving nova:compute:pci class invocation to
before nova::compute in order to handle the duplicate declaration.

[1] https://review.opendev.org/c/x/packstack/+/762100
[2] https://review.opendev.org/q/I5b3d9dbbd41d060134444609458b3e8bba606ae6

Also make multinode c7 job non voting to unblock c8 puppet
promotion, c7 phase 1 based promotion is too old so making
it non voting until it's cleared.

Change-Id: I618aa1fb568a296558bd8a888bb9ae201c24ea76
(cherry picked from commit 5a6874c0ec103ee580c2f8bfb7b35c1f6fd7d99f)
---
 .zuul.yaml                                                | 4 ++--
 .../puppet/modules/packstack/manifests/nova/compute.pp    | 8 ++++----
 2 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/.zuul.yaml b/.zuul.yaml
index 599755e0..0570e472 100644
--- a/.zuul.yaml
+++ b/.zuul.yaml
@@ -228,7 +228,8 @@
         - packstack-integration-scenario001-tempest
         - packstack-integration-scenario002-tempest
         - packstack-integration-scenario003-tempest
-        - packstack-multinode-scenario002-tempest
+        - packstack-multinode-scenario002-tempest:
+            voting: false
         # We can't make centos8 jobs voting until we have promotion pipeline
         - packstack-centos8-integration-scenario001:
             voting: false
@@ -250,7 +251,6 @@
         - packstack-integration-scenario001-tempest
         - packstack-integration-scenario002-tempest
         - packstack-integration-scenario003-tempest
-        - packstack-multinode-scenario002-tempest
     post:
       jobs:
         - packstack-upload-git-mirror
diff --git a/packstack/puppet/modules/packstack/manifests/nova/compute.pp b/packstack/puppet/modules/packstack/manifests/nova/compute.pp
index 0ffd4220..532e3219 100644
--- a/packstack/puppet/modules/packstack/manifests/nova/compute.pp
+++ b/packstack/puppet/modules/packstack/manifests/nova/compute.pp
@@ -73,6 +73,10 @@ class packstack::nova::compute ()
       $instance_usage_audit_period = 'month'
     }
 
+    class { '::nova::compute::pci':
+      passthrough => hiera('CONFIG_NOVA_PCI_PASSTHROUGH_WHITELIST')
+    }
+
     class { '::nova::compute':
       enabled                       => true,
       vncproxy_host                 => hiera('CONFIG_KEYSTONE_HOST_URL'),
@@ -90,10 +94,6 @@ class packstack::nova::compute ()
       region_name => hiera('CONFIG_KEYSTONE_REGION'),
     }
 
-    class { '::nova::compute::pci':
-      passthrough => hiera('CONFIG_NOVA_PCI_PASSTHROUGH_WHITELIST')
-    }
-
     include ::nova::cell_v2::discover_hosts
 
     Class['nova::compute'] ~> Class['nova::cell_v2::discover_hosts']
-- 
2.20.1

